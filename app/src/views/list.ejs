<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document : list</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="/main.css" rel="stylesheet"> -->
</head>
<body class="grey-bg">
    <%- include('nav.ejs') %> 
    <!-- <%= JSON.stringify(ê¸€ëª©ë¡) %> -->

    <input class="search" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button class="search-send">ê²€ìƒ‰í•˜ê¸°</button>

    <script>
        document.querySelector('.search-send').addEventListener('click', function() {
            let searchVal = document.querySelector('.search').value
            location.href = '/search?val=' + searchVal
        })
    </script>

    <div class="white-bg">
    

    <% for (var i = 0; i < ê¸€ëª©ë¡.length; i++){ %>

        <div class="list-box">
        
            <h4><a href="/detail/<%= ê¸€ëª©ë¡[i]._id %>">
                â¤ï¸<%= ê¸€ëª©ë¡[i].title %></h4>
                <p><%= ê¸€ëª©ë¡[i].content %></a></p>
            <div>
                <a href="/edit/<%= ê¸€ëª©ë¡[i]._id %>">ğŸ–Šï¸ìˆ˜ì •</a>
            </div>
            <% if (ìœ ì €ê²Œì‹œë¬¼ && ìœ ì €ê²Œì‹œë¬¼.some(post => post._id.equals(ê¸€ëª©ë¡[i]._id))) { %>
                <span class="delete" data-id="<%= ê¸€ëª©ë¡[i]._id %>">ğŸ—‘ï¸ì‚­ì œ  </span>
            <% } %>
        </div>
    
    <% } %> 

    </div> 



    <nav aria-label="Page navigation example">
        <ul class="pagination">
            <% if (í˜„ì¬í˜ì´ì§€ > 1) { %>
                <li class="page-item">
                    <a class="page-link" href="/list/<%= í˜„ì¬í˜ì´ì§€ - 1 %>">ì´ì „</a>
                </li>
            <% } %>
            <% for (var i = ì‹œì‘í˜ì´ì§€; i <= ëí˜ì´ì§€; i++) { %>
                <li class="page-item">
                    <a class="page-link <%= i == í˜„ì¬í˜ì´ì§€ ? 'active' : '' %>" href="/list/<%= i %>"><%= i %></a>
                </li>
            <% } %>
            <% if (ëí˜ì´ì§€ < ì´í˜ì´ì§€) { %>
                <li class="page-item">
                    <a class="page-link" href="/list/<%= ëí˜ì´ì§€ + 1 %>">ë‹¤ìŒ</a>
                </li>
            <% } %>
        </ul>
    </nav>
    


    <script>


        document.querySelectorAll('.delete').forEach(function (deleteButton) {
            deleteButton.addEventListener('click', function (e) {
                var docId = e.target.dataset.id;
                fetch('/doc?docid=' + docId, {
                    method: 'DELETE',
                })
                .then(function (response) {
                    if (response.status === 200) {
                        // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆì„ ë•Œ ìƒˆë¡œê³ ì¹¨
                        location.reload();
                    } else {
                        // ì‚­ì œ ì‹¤íŒ¨ ì‹œì— ëŒ€í•œ ì²˜ë¦¬
                        console.error('ì‚­ì œ ì‹¤íŒ¨:', response.statusText);
                    }
                })
                .catch(function (error) {
                    console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                });
            });
        });
    </script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script> -->
    
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOMContentLoaded event fired');

            let eventSource = new EventSource('/stream/list');

            eventSource.addEventListener('open', function(e) {
                console.log('Connection to server opened.');
            });

            eventSource.addEventListener('postChange', function(e) {
                console.log('New post event received:', e.data);
                let ê°€ì ¸ì˜¨ê±° = JSON.parse(e.data);
                console.log('Parsed data:', ê°€ì ¸ì˜¨ê±°);
                document.querySelector('.white-bg').insertAdjacentHTML('afterbegin', `<div class="list-box"><h4>${ê°€ì ¸ì˜¨ê±°.title}</h4><p>${ê°€ì ¸ì˜¨ê±°.content}</p></div>`);
                console.log('New post added to DOM');
            });

            eventSource.addEventListener('error', function(e) {
                if (e.readyState == EventSource.CLOSED) {
                    console.log('Connection was closed.');
                } else {
                    console.log('An error occurred:', e);
                }
            });
        });
    </script>


  </body>
</html>